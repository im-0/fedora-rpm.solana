From a271c86c236e65f181fc409fa785588f9a69877f Mon Sep 17 00:00:00 2001
From: "mergify[bot]" <37929162+mergify[bot]@users.noreply.github.com>
Date: Tue, 30 Aug 2022 15:36:32 +0000
Subject: [PATCH 1/2] clean_dead_slots_from_accounts_index unrefs correctly
 (backport #27461) (#27467)

clean_dead_slots_from_accounts_index unrefs correctly (#27461)

(cherry picked from commit a4b8ab2f590ca4d257e9c00e5320ce1aa1732177)

Co-authored-by: Jeff Washington (jwash) <wash678@gmail.com>
(cherry picked from commit 7650bd2ad6feb0f7acca16b9a0da9a7bd9cf87f9)

# Conflicts:
#	runtime/src/accounts_db.rs
---
 runtime/src/accounts_db.rs | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/runtime/src/accounts_db.rs b/runtime/src/accounts_db.rs
index 5768b4f0f1343..e1a5810ff91d1 100644
--- a/runtime/src/accounts_db.rs
+++ b/runtime/src/accounts_db.rs
@@ -6219,8 +6219,12 @@ impl AccountsDb {
         let mut accounts_index_root_stats = AccountsIndexRootsStats::default();
         let mut measure = Measure::start("unref_from_storage");
         if let Some(purged_stored_account_slots) = purged_stored_account_slots {
+<<<<<<< HEAD
             let len = purged_stored_account_slots.len();
             // we could build a higher level function in accounts_index to group by bin
+=======
+            let len = purged_slot_pubkeys.len();
+>>>>>>> 7650bd2ad (clean_dead_slots_from_accounts_index unrefs correctly (backport #27461) (#27467))
             const BATCH_SIZE: usize = 10_000;
             let batches = 1 + (len / BATCH_SIZE);
             self.thread_pool_clean.install(|| {

From 34cae5bdf65f2c619d070e4a25ca32acacb996a8 Mon Sep 17 00:00:00 2001
From: jeff washington <jeff.washington@solana.com>
Date: Wed, 7 Sep 2022 15:24:19 -0500
Subject: [PATCH 2/2] manually resolve conflicts

---
 runtime/src/accounts_db.rs | 6 +-----
 1 file changed, 1 insertion(+), 5 deletions(-)

diff --git a/runtime/src/accounts_db.rs b/runtime/src/accounts_db.rs
index e1a5810ff91d1..275b73738c33f 100644
--- a/runtime/src/accounts_db.rs
+++ b/runtime/src/accounts_db.rs
@@ -6219,12 +6219,8 @@ impl AccountsDb {
         let mut accounts_index_root_stats = AccountsIndexRootsStats::default();
         let mut measure = Measure::start("unref_from_storage");
         if let Some(purged_stored_account_slots) = purged_stored_account_slots {
-<<<<<<< HEAD
-            let len = purged_stored_account_slots.len();
-            // we could build a higher level function in accounts_index to group by bin
-=======
             let len = purged_slot_pubkeys.len();
->>>>>>> 7650bd2ad (clean_dead_slots_from_accounts_index unrefs correctly (backport #27461) (#27467))
+            // we could build a higher level function in accounts_index to group by bin
             const BATCH_SIZE: usize = 10_000;
             let batches = 1 + (len / BATCH_SIZE);
             self.thread_pool_clean.install(|| {
